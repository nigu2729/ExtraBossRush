package com.ExtraBossRush.GoM.Entity;

import net.minecraft.nbt.CompoundTag;
import net.minecraft.server.level.ServerLevel;
import net.minecraft.server.level.ServerPlayer;
import net.minecraftforge.event.TickEvent;
import net.minecraftforge.event.entity.player.PlayerEvent;
import net.minecraftforge.event.entity.living.LivingDeathEvent;
import net.minecraftforge.eventbus.api.SubscribeEvent;
import net.minecraftforge.fml.common.Mod;

import java.util.UUID;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

@Mod.EventBusSubscriber(modid = com.ExtraBossRush.ExtraBossRush.MOD_ID, bus = Mod.EventBusSubscriber.Bus.FORGE)
public class GoMInvulnerabilityManager {

    private static final String PERSIST_KEY = "GoM_ResetInvTimeTick";

    // UUID -> 残り停止時間（tick）
    private static final ConcurrentMap<UUID, Integer> remainingTicks = new ConcurrentHashMap<>();

    /**
     * 上書き（overwrite）方式で残りtickを設定する。
     * ticks <= 0 は無視。
     */
    public static void requestResetInvulnerableTicks(ServerPlayer player, int ticks) {
        if (player == null || ticks <= 0) return;
        UUID id = player.getUUID();
        remainingTicks.put(id, ticks); // 上書き
        // 即時効果
        player.hurtMarked = true;
        player.invulnerableTime = 0;
        player.getPersistentData().putInt(PERSIST_KEY, ticks); // ローカル persistent にも保存しておく
    }

    /**
     * UUID + ServerLevel から呼ぶ場合（ログイン復元など）。
     */
    public static void requestResetInvulnerableTicks(UUID uuid, int ticks, ServerLevel level) {
        if (uuid == null || level == null || ticks <= 0) return;
        ServerPlayer player = level.getServer().getPlayerList().getPlayer(uuid);
        if (player == null) {
            // プレイヤー不在でも永続領域に書いておく（ログイン時に復元される）
            // ここは省略可能。現状は存在時のみ設定。
            return;
        }
        requestResetInvulnerableTicks(player, ticks);
    }

    public static int getRemainingTicks(UUID uuid) {
        return remainingTicks.getOrDefault(uuid, 0);
    }

    // PlayerTickEvent でカウントダウン
    @SubscribeEvent
    public static void onPlayerTick(TickEvent.PlayerTickEvent event) {
        if (event.phase != TickEvent.Phase.END) return;
        if (!(event.player instanceof ServerPlayer player)) return;

        UUID id = player.getUUID();
        Integer rem = remainingTicks.get(id);
        if (rem != null && rem > 0) {
            // 無敵時間を常に 0 に維持
            player.invulnerableTime = 0;
            rem = rem - 1;
            if (rem <= 0) {
                // 終了: 元に戻す
                player.invulnerableTime = 20;
                remainingTicks.remove(id);
                player.getPersistentData().remove(PERSIST_KEY);
            } else {
                remainingTicks.put(id, rem);
                player.getPersistentData().putInt(PERSIST_KEY, rem);
            }
        } else {
            // クリーンアップ: persistent に残っていれば除去
            if (player.getPersistentData().contains(PERSIST_KEY)) {
                player.getPersistentData().remove(PERSIST_KEY);
            }
        }
    }
    // 死亡時は manager の状態をクリア（再スポーン後は持ち越さない）
    @SubscribeEvent
    public static void onPlayerDeath(LivingDeathEvent event) {
        if (!(event.getEntity() instanceof ServerPlayer player)) return;
        UUID id = player.getUUID();
        remainingTicks.remove(id);
        player.getPersistentData().remove(PERSIST_KEY);
    }
}